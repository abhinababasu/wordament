
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Word Element</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" media="screen and (orientation:portrait)" type="text/css" href="small.css" />
<link rel="stylesheet" media="screen and (min-width:200px) and (max-width: 799px)" type="text/css" href="small.css" />
<link rel="stylesheet" media="screen and (min-width: 800px)" type="text/css" href="default.css" />
<script type="text/javascript" src="http://www.google.com/jsapi"></script>
<script type="text/javascript">google.load("jquery", "1.6.0");</script>
<script type="text/javascript">

    // Create the XHR object.
    function createCORSRequest(method, url) {
        var xhr = new XMLHttpRequest();
        if ("withCredentials" in xhr) {
            // XHR for Chrome/Firefox/Opera/Safari.
            xhr.open(method, url, true);
        } else if (typeof XDomainRequest != "undefined") {
            // XDomainRequest for IE.
            xhr = new XDomainRequest();
            xhr.open(method, url);
        } else {
            // CORS not supported.
            xhr = null;
        }
        return xhr;
    }

    function getResultString(m, res) {
        var s = ''
        for (var ri = 0; ri < res.length; ++ri) {
            var r = res[ri].Row
            var c = res[ri].Col
            s = s + String.fromCharCode(m[r][c])
        }

        return s
    }

    function getResultsMatrix(m, res) {
        var table = document.createElement("table")
        table.className = "MatrixResultTable"


        for (var i = 0; i < 4; i++){
            var row = table.insertRow(-1)
            for (var j = 0; j < 4; j++){
                cell = row.insertCell(-1)
                cell.innerHTML = String.fromCharCode(m[i][j])
                cell.style.color = "#EEEEEE"
            }
        }

        var r = 0
        var g = 0
        var b = 0

        for (var ri = 0; ri < res.length; ++ri) {
            var row = res[ri].Row
            var col = res[ri].Col
            var cell = table.rows[row].cells[col]
            cell.innerHTML = String.fromCharCode(m[row][col])
            cell.style.color = "#AA0000"
        }

        var inc = Math.floor(255 / res.length)
        for (var ri = 0; ri < res.length; ++ri) {
            var row = res[ri].Row
            var col = res[ri].Col
            var cell = table.rows[row].cells[col]
            textColor = rgbToHex(r, g, b)
            cell.style.backgroundColor = textColor
            r+=inc
            g+=inc
            b+=inc
        }
        
        return table

    }

    function getDisplayMatrix(m) {
        var table = document.createElement("table")
        table.className = "MatrixTable"
        for (var i = 0; i < 4; i++){
            var row = table.insertRow(-1)
            for (var j = 0; j < 4; j++){
                cell = row.insertCell(-1)
                cell.innerHTML = String.fromCharCode(m[i][j])
            }
        }

        return table

    }

    // Make the actual CORS request.
    function fetchElement() {
        var inputText = document.getElementById('WordBox').value;

        // input text shows as caps in UI because of css, actually convert to uppercase to 
        // send to API
        inputText = inputText.toUpperCase()

        var banner = document.getElementById("BannerImg");
        banner.src = "./banner_narrow.jpg";

        if (inputText.length != 16) {
            alert("Has to be 16")
            return 
        }
        
        $("#PromptDiv").empty();
        $("#InputMatrixDiv").empty();
        $("#AllResultsDiv").empty();

        var url = 'http://commonvm1.westus2.cloudapp.azure.com:8090/?input=' + inputText;
        var xhr = createCORSRequest('GET', url);
        if (!xhr) {
            alert('CORS not supported');
            return;
        }

        // Response handlers.
        xhr.onload = function() {
            var text = xhr.responseText;
            var res = JSON.parse(text);
            
            var table = getDisplayMatrix(res.Input)
            $("#InputMatrixDiv").append(table)

            $("#AllResultsDiv").append('<h1>Results - </h1>')

            for (var ri = 0; ri < res.Result.length; ++ri) {
                var resString = getResultString(res.Input, res.Result[ri])
                $("#AllResultsDiv").append('<h3>' +  ri + '- ' + resString + '</h3>');

                var resultTable = getResultsMatrix(res.Input, res.Result[ri])
                $("#AllResultsDiv").append(resultTable)   
            }

            $("#AllResultsDiv").keydown(function( event ) {
                /*if ( event.which == 13 ) {
                    event.preventDefault();
                }*/
                alert('key!!');
            }
            );
        };
        
        xhr.onerror = function(e) {
            $("#AllResultsDiv").html('<h3>Woops, there was an error making the request</h3>');
            console.log(e);
        
        };

        xhr.send();
    }

    function componentToHex(c) {
        var hex = c.toString(16);
        return hex.length == 1 ? "0" + hex : hex;
    }

    function rgbToHex(r, g, b) {
        return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
    }

    function resultKeyDownHandler() {
        alert("Key!!!")
    }


    
</script>
</head>

<body>
    <div id="mainDiv">
        <img id="BannerImg" src="./banner.png" />
        <div id="InputDiv">
            <input type="text" id="WordBox" placeholder="Type all 16 wordament letters"/>
            <button id="WordButton" onclick="fetchElement()">Get Elements</button>
            <div id="PromptDiv">Try - SPAVURNYGERSMSBE</div>
        </div>
        <div id="InputMatrixDiv"></div>
        <div id="AllResultsDiv" tabindex="0"></div>
   </div>
 </body>
</html>
